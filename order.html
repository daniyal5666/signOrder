<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const BASE_URL = "https://8a878ae06981.ngrok-free.app";
    </script>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      .field {
        margin-bottom: 10px;
      }
      button {
        background: #4f46e5;
        color: white;
        padding: 8px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background: #4338ca;
      }
    </style>
  </head>
  <body>
    <h2>Place Order</h2>

    <div class="field">
      <label>Market</label>
      <select id="marketId"></select>
    </div>
    <div class="field">
      <label>Outcome</label>
      <select id="outcome">
        <option value="YES">YES</option>
        <option value="NO">NO</option>
      </select>
    </div>
    <div class="field">
      <label>Order Type</label>
      <select id="orderType">
        <option value="limit">Limit</option>
        <option value="market">Market</option>
      </select>
    </div>
    <div class="field">
      <label>Price (for limit)</label>
      <input id="price" type="number" step="0.001" value="0.50" />
    </div>
    <div class="field">
      <label>Quantity</label>
      <input id="quantity" type="number" step="0.1" value="10" />
    </div>

    <button onclick="placeOrder()">Place Order</button>

    <p id="status"></p>

    <script>
      async function loadMarkets() {
        const select = document.getElementById("marketId");
        select.innerHTML = "<option>Loading markets...</option>";
        try {
          const res = await fetch(`${BASE_URL}/api/v1/get-enabled-orders`);
          const markets = await res.json();

          select.innerHTML = "";
          markets.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.textContent = m.question;
            select.appendChild(opt);
          });
        } catch (e) {
          console.error(e);
          select.innerHTML = "<option>Error loading markets</option>";
        }
      }

      document.addEventListener("DOMContentLoaded", loadMarkets);

      async function placeOrder() {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "Connecting wallet...";

        if (!window.ethereum) {
          statusEl.textContent = "MetaMask/Rabby wallet not found";
          return;
        }

        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const address = await signer.getAddress();

        const marketId = document.getElementById("marketId").value;
        const outcome = document.getElementById("outcome").value;
        const orderType = document.getElementById("orderType").value;
        const price = parseFloat(document.getElementById("price").value);
        const quantity = parseFloat(document.getElementById("quantity").value);

        statusEl.textContent = "Signing order...";
        const network = await provider.getNetwork();
        const chainId = Number(network.chainId);

        const domain = {
          name: "Polymarket",
          version: "1",
          chainId,
          verifyingContract: "0x066a3d9d8399afcc29b5ab0d48743cd22600f295",
        };

        const types = {
          Order: [
            { name: "marketId", type: "string" },
            { name: "outcome", type: "string" },
            { name: "orderType", type: "string" },
            { name: "price", type: "uint256" },
            { name: "quantity", type: "uint256" },
          ],
        };

        const value = {
          marketId,
          outcome,
          orderType,
          price: ethers.parseUnits(price.toString(), 6),
          quantity: ethers.parseUnits(quantity.toString(), 6),
        };

        const signature = await signer.signTypedData(domain, types, value);

        const orderPayload = {
          marketId,
          outcome,
          orderType,
          price,
          quantity,
          address,
          signature,
        };

        statusEl.textContent = "Submitting order...";
        window.opener.postMessage({ type: "order_placed", orderPayload }, "*");
      }
    </script>
  </body>
</html>
